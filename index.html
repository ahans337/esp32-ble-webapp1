<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ESP32 BLE Graph + Input</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h2>ESP32 BLE Live Data</h2>
  <button onclick="connectToESP32()">Connect to ESP32 BLE</button>
  <button onclick="scanServices()">Scan Services</button>
  <br><br>
  <input type="text" id="inputBox" placeholder="Enter mass (lbs)">
<button onclick="sendToESP32()">Send to ESP32</button>
<br><br>
<button id="toggleButton" onclick="toggleDataStream()">Start</button>
  <br><br>
  <canvas id="chart" width="600" height="300"></canvas>

  <script>
    const serviceUUID = 'e2164c18-4049-483d-8c74-8a7d382f2834';
    const charUUID    = 'd34db33f-dead-beef-cafe-babec0010001';
    const comUUID     = 'b21d2927-093b-4c5b-9b6a-0555cde8cee5';

    let chart;
    const data = [], labels = [], fullData = [];
    let charCOM = null;

    window.onload = () => {
      const ctx = document.getElementById('chart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Total Force (N)',
            borderColor: 'blue',
            data: data,
            fill: false
          }]
        },
        options: {
          animation: false,
          scales: {
            x: { display: true, title: { display: true, text: "Time (s)" } },
            y: { beginAtZero: true, title: { display: true, text: "Total Force (N)" } }
          }
        }
      });
    };

    async function connectToESP32() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: [serviceUUID]
        });

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(serviceUUID);

        // LIVE characteristic
        const characteristic = await service.getCharacteristic(charUUID);
        await characteristic.startNotifications();
        characteristic.addEventListener('characteristicvaluechanged', handleNotification);

        // COM characteristic
        charCOM = await service.getCharacteristic(comUUID);
        console.log("‚úÖ COM characteristic ready");

      } catch (error) {
        console.error("‚ùå BLE connection error:", error);
      }
    }

    async function scanServices() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: [serviceUUID]
        });

        const server = await device.gatt.connect();
        const services = await server.getPrimaryServices();

        for (const service of services) {
          console.log('üîé Found service:', service.uuid);
          const characteristics = await service.getCharacteristics();
          for (const characteristic of characteristics) {
            console.log('  ‚Ü≥ Characteristic:', characteristic.uuid);
          }
        }
      } catch (error) {
        console.error("‚ùå Scan failed:", error);
      }
    }

    async function sendToESP32() {
      const input = document.getElementById("inputBox").value;
      if (!charCOM) {
        alert("‚ùå Not connected to COM characteristic.");
        return;
      }

      if (input.trim() === "") {
        alert("‚ö†Ô∏è Input is empty.");
        return;
      }

      try {
        const encoder = new TextEncoder();
        await charCOM.writeValue(encoder.encode(input.trim()));
        console.log("üì§ Sent to ESP32:", input.trim());
      } catch (error) {
        console.error("‚ùå Write failed:", error);
      }
    }
let dataStreaming = false;

async function toggleDataStream() {
  if (!charCOM) {
    alert("‚ùå Not connected to ESP32.");
    return;
  }

  const command = dataStreaming ? "CMD_STOP" : "CMD_START";

  try {
    const encoder = new TextEncoder();
    await charCOM.writeValue(encoder.encode(command));
    dataStreaming = !dataStreaming;

    const btn = document.getElementById("toggleButton");
    btn.textContent = dataStreaming ? "Stop" : "Start";

    console.log(`üì§ Sent ${command} to ESP32`);
  } catch (error) {
    console.error("‚ùå Failed to send start/stop:", error);
  }
}
   function handleNotification(event) {
  const value = new TextDecoder('utf-8').decode(event.target.value).trim();
  console.log("üîî Notification received:", value);

  // Skip non-numeric or non-live data
  if (value.startsWith("PEAK") || isNaN(value.split(",")[0])) {
    console.log("‚è© Skipped non-live data");
    return;
  }

  const parts = value.split(",");
  if (parts.length < 2) return;

  const timeMs = parseInt(parts[0]);
  const totalForce = parseFloat(parts[1]);

  if (!isNaN(timeMs) && !isNaN(totalForce)) {
    const timeSec = (timeMs / 1000).toFixed(2);
    fullData.push({ time: timeSec, load: totalForce });
    data.push(totalForce);
    labels.push(timeSec + "s");

    if (data.length > 50) {
      data.shift();
      labels.shift();
    }

    chart.update();
  }
}
  </script>
</body>
</html>
